name: Wheels

on:
  workflow_call:
    inputs:
      name:
        required: true
        type: string
        description: "Package to build (numpy, scipy)"
      repo:
        required: true
        type: string
        description: "Repo to build (numpy, scipy)"
      force-build:
        required: false
        type: boolean
        description: "Force build even if wheels exist"
      manylinux:
        required: false
        type: boolean
        description: "Build Linux wheels in manylinux container"
      version:
        required: false
        type: string
        description: "Version to build (default: latest release)"

jobs:
  meta:
    if: github.repository == 'urob/numpy-mkl'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ env.VERSION }}
      matrix: ${{ env.MATRIX }}
      tag: ${{ env.TAG }}

    steps:
      - name: Check out repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false


      - name: Install uv
        uses: astral-sh/setup-uv@2ddd2b9cb38ad8efd50337e8ab201519a34c9f24 # v7.1.1
        with:
          version-file: "pyproject.toml"
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      - name: Fetch package version
        run: |
          if [[ -z "${{ inputs.version }}" ]]; then
            if ${{ inputs.name == 'mkl-service' }}; then
              VERSION="$(uv run tools/fetch_matrix ${{ inputs.name }} --github)"
              TAG="$(uv run tools/fetch_matrix ${{ inputs.name }} --tag)"
            else
              VERSION="$(uv run tools/fetch_matrix ${{ inputs.name }} ${fetch_args})"
            fi
          else
            VERSION="${{ inputs.version }}"
          fi
          echo "VERSION=${VERSION}" >>$GITHUB_ENV
          echo "TAG=${TAG:-v${VERSION}}" >>$GITHUB_ENV

      # TODO: Reuse version / respect explicit version overwrites.
      - name: Fetch build matrix
        run: |
          fetch_args="--store build.json --runs-on ubuntu-22.04"
          fetch_args="${fetch_args} --runs-on windows-2022"
          ${{ inputs.force-build }} && fetch_args="${fetch_args} --force-build"
          ${{ inputs.name == 'mkl-service' }} && fetch_args="${fetch_args} --github"
          MATRIX="$(uv run tools/fetch_matrix ${{ inputs.name }} ${fetch_args})"
          echo "MATRIX=${MATRIX}" >>$GITHUB_ENV
          echo "${MATRIX}" | yq -P -o yaml

  #-----------------------------------------------------------------------------------------------
  build:
    name: ${{ inputs.name }}-${{ matrix.python }} (${{ matrix.runs-on }})
    if: ${{ needs.meta.outputs.matrix != 'null' }}
    needs: meta
    runs-on: ${{ matrix.runs-on }}
    container:
      ${{ fromJSON(inputs.manylinux) && startsWith(matrix.runs-on, 'ubuntu')
        && 'quay.io/pypa/manylinux_2_28_x86_64' || null }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.meta.outputs.matrix) }}
    continue-on-error: true
    defaults:
      run:
        shell: bash

    steps:
      - name: Check out repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Check out src
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          repository: ${{ inputs.repo }}
          ref: ${{ needs.meta.outputs.tag }}
          path: src
          submodules: recursive
          persist-credentials: false

      - name: Prepare environment
        run: |
          # Need this since pyproject.toml doesn't apply to $SRC_DIR.
          echo "UV_PYTHON_PREFERENCE=only-managed" >>$GITHUB_ENV

          case "${{ runner.os }}" in
            Linux) echo "venv_bin=bin" >>$GITHUB_ENV ;;
            Windows) echo "venv_bin=Scripts" >>$GITHUB_ENV ;;
          esac

          # Move src to avoid pyproject conflicts. SRC_DIR is set relative to GITHUB_WORKSPACE to
          # preserve the "D:\" prefix on Windows. (Pure Linux paths aren't supported as arguments
          # to 'working-directory'.)
          mv src ../../ && echo "SRC_DIR=${GITHUB_WORKSPACE}/../../src" >>$GITHUB_ENV

          # Keep MKL directory short as it ends up in the final build.
          echo "MKL_DIR=$(realpath "${GITHUB_WORKSPACE}"/../../mkl)" >>$GITHUB_ENV

      - name: Install uv
        uses: astral-sh/setup-uv@2ddd2b9cb38ad8efd50337e8ab201519a34c9f24 # v7.1.1
        with:
          python-version: ${{ matrix.python }}
          version-file: "pyproject.toml"
          enable-cache: false

      - name: Install MKL libraries
        run: |
          uv venv "${{ env.MKL_DIR }}"
          source "${{ env.MKL_DIR }}/${{ env.venv_bin }}"/activate
          uv pip install mkl-devel

          # Get MKL version.
          echo "MKL_VERSION=$(uv pip show mkl | grep '^Version' | sed 's/Version: //')" \
              >>$GITHUB_ENV

          # Get pkg-config path.
          echo "PKG_CONFIG_PATH=$(python tools/get_file_in_pkg mkl-sdl.pc \
              --pkg mkl-devel --parent)" >>$GITHUB_ENV

          # Fetch MKL license.
          cat "$(python tools/get_file_in_pkg LICENSE.txt --pkg mkl-devel)" \
              >>"${GITHUB_WORKSPACE}/patches/LICENSE_MKL.txt"

          # Add .so -> .so.2 symlinks to fix linking for mkl-service.
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            cd "${{ env.MKL_DIR }}"/lib
            for i in $( ls libmkl*.so.2 ); do ln -s $i ${i%.*}; done
          fi

      - name: Apply patches
        run: |
          # Apply patches.
          cd "${{ env.SRC_DIR }}"
          git apply "${GITHUB_WORKSPACE}"/patches/${{ inputs.name }}/*.patch

          # Fix MKL pkg-config on Windows.
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            cp "${GITHUB_WORKSPACE}"/patches/mkl/*.pc "${PKG_CONFIG_PATH}/"
          fi

      - name: Add MKL to runtime dependencies
        working-directory: ${{ env.SRC_DIR }}
        run: |
          # Pin runtime library to the exact version used for compiling.
          if [[ "${{ inputs.name }}" == "mkl-service" ]]; then
            # MKLROOT must be set, even with --no-sync.
            MKLROOT="${{ env.MKL_DIR }}" uv add --no-sync mkl>="${{ env.MKL_VERSION }}"
          else
            uv add --no-sync mkl>="${{ env.MKL_VERSION }}" mkl-service
          fi

      - name: Add MKL licence
        working-directory: ${{ env.SRC_DIR }}
        run: |
          echo "" >>LICENSE.txt
          echo "----" >>LICENSE.txt
          echo "" >>LICENSE.txt
          cat LICENSES_bundled.txt >>LICENSE.txt
          cat "${GITHUB_WORKSPACE}/patches/LICENSE_MKL.txt" >>LICENSE.txt
        if: inputs.name != 'mkl-service'

      - name: Install Windows build dependencies
        run: |
          # Use fall-through operator ';&' to match all cases.
          case "${{ inputs.name }}" in
            numpy | scipy)
              # Pkg-config is required for numpy and scipy.
              choco install -y --no-progress --stoponfirstfailure \
                  --checksum 6004DF17818F5A6DBF19CB335CC92702 pkgconfiglite
              ;&
            scipy)
              # Gcc is required for scipy.
              choco install rtools -y --no-progress --force --version=4.0.0.20220206
              echo "c:\rtools40\ucrt64\bin;" >>$GITHUB_PATH
              ;&
          esac
        if: runner.os == 'windows'

      - name: Install manylinux build dependencies
        run: |
          case "${{ inputs.name }}" in
            mkl-service)
              dnf -y install clang
              ;&
            numpy)
              # Tests for distutil require clang (Python < 3.12).
              [[ "$UV_PYTHON" =~ ^(cp310|cp311)$ ]] && dnf -y install clang || true
              ;&
          esac
        if: (runner.os == 'linux') && inputs.manylinux

      - name: Build wheel
        working-directory: ${{ env.SRC_DIR }}
        run: |
          case "${{ inputs.name }}" in
            numpy)
              args="-Csetup-args=-Dblas=mkl-sdl \
                    -Csetup-args=-Dlapack=mkl-sdl \
                    -Csetup-args=-Dallow-noblas=false \
                    -Csetup-args=-Dcpu-baseline=F16C \
                    -Csetup-args=-Dcpu-dispatch=AVX512_ICL"
              [[ "${{ runner.os }}" == "Windows" ]] && args="${args} -Csetup-args=--vsenv"
              ;;

            scipy)
              # MSVC is unable to compile Pythran, use gcc or set -Duse-pythran=false.
              args="-Csetup-args=-Dblas=mkl-sdl \
                    -Csetup-args=-Dlapack=mkl-sdl \
                    -Csetup-args=-Duse-g77-abi=true"
              ;;

            'mkl-service')
              case "${{ runner.os }}" in
                Linux) export MKLROOT="${{ env.MKL_DIR }}" ;;
                Windows) export MKLROOT="${{ env.MKL_DIR }}"/Library ;;
              esac
              export CFLAGS="${CFLAGS} -fno-fast-math"
              args="--no-build-isolation"
              uv venv buildenv && source buildenv/"${{ env.venv_bin }}"/activate
              uv pip install setuptools cython
              ;;
          esac
          uv build --wheel --index https://urob.github.io/numpy-mkl ${args}

      - name: Repair wheel (Linux)
        run: |
          mkdir -p wheelhouse
          plat="$(ldd --version | head -1 | awk '{ print $NF }' | tr '.' '_')_$(uname -m)"
          uvx auditwheel repair "${{ env.SRC_DIR }}"/dist/*.whl -w wheelhouse \
              --exclude 'libmkl*' --plat=manylinux_${plat}
        if: runner.os == 'linux'

      - name: Repair wheel (Windows)
        run: |
          mkdir -p wheelhouse
          uvx delvewheel repair "${{ env.SRC_DIR }}"/dist/*.whl -w wheelhouse \
              --exclude mkl_rt.2.dll --exclude libsf_error_state.dll
        if: runner.os == 'windows'

      - name: Run tests
        run: |
          # Make sure we don't pick up the development MKL libraries.
          rm -rf "${{ env.MKL_DIR }}"

          # Set up test environment.
          uv venv testenv && source testenv/"${{ env.venv_bin }}"/activate
          uv pip install wheelhouse/*.whl --index https://urob.github.io/numpy-mkl

          case "${{ inputs.name }}" in
            numpy)
              uv pip install -r "${{ env.SRC_DIR }}"/requirements/test_requirements.txt
              uv pip install threadpoolctl
              python tools/numpy_tests.py
              ;;

            scipy)
              uv pip install -r "${{ env.SRC_DIR }}"/requirements/test.txt \
                  --index https://urob.github.io/numpy-mkl
              python -c 'import sys; import scipy; sys.exit(not scipy.test())'
              ;;

            mkl-service)
              uv pip install pytest
              pytest -s -v --pyargs mkl
              ;;
          esac

      - name: Store build information
        run: |
          mkdir -p wheelhouse
          cat >wheelhouse/versions-${{ matrix.python}}-${{ runner.os }}.json <<EOF
          {
            "name": "${{ inputs.name }}",
            "version": "${{ needs.meta.outputs.version }}",
            "python": "${{ matrix.python }}",
            "os": "${{ runner.os }}",
            "mkl": "${{ env.MKL_VERSION }}"
          }
          EOF

      - name: Archive
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ inputs.name }}-${{ matrix.python }}-${{ runner.os }}
          path: |
            wheelhouse/*.whl
            wheelhouse/*.json
          retention-days: 1

  #-----------------------------------------------------------------------------------------------
  release:
    if: ${{ needs.meta.outputs.matrix != 'null' }}
    needs: [meta, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          # Explicitly set ref to include commits from the meta job.
          # https://github.com/actions/checkout/issues/439#issuecomment-830862188
          ref: main
          path: main
          persist-credentials: true  # Need credentials to push.

      - name: Checkout deployment branch
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: pypi
          path: pypi
          persist-credentials: true  # Need credentials to push.

      - name: Install uv
        uses: astral-sh/setup-uv@2ddd2b9cb38ad8efd50337e8ab201519a34c9f24 # v7.1.1
        with:
          version-file: "main/pyproject.toml"
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      # - name: Create directory for wheels
      #   run: |
      #     mkdir wheelhouse

      - name: Fetch wheels
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          pattern: ${{ inputs.name }}-*
          path: wheelhouse
          merge-multiple: true

      - name: Bump project version
        working-directory: main
        run: |
          uv version --bump patch
          echo "VERSION=$(uv version --short)" >>$GITHUB_ENV

      - name: Store build metadata
        run: |
          main/tools/store_info.py wheelhouse/*.json --store main/build.json
          rm wheelhouse/*.json

      - name: Update badges
        run: |
          main/tools/update_icons --store main/build.json --readme main/README.md

      - name: Commit release data
        working-directory: main
        run: |
          if [[ -z "$(git status --porcelain)" ]]; then
              echo "No changes to commit"
              exit 0
          fi
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          git add .
          git commit -m "ci: Prepare release for ${{ inputs.name }}-${{ needs.meta.outputs.version }}"
          git push origin HEAD:main

      - name: Write release notes
        working-directory: main
        run: |
          NOTES=$(uv run tools/release_notes --store build.json --template templates/release.md)
          echo "NOTES=${NOTES}" >>$GITHUB_ENV

      - name: Release wheels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${VERSION}" --title "${VERSION}" --notes "${NOTES}" wheelhouse/*

      - name: Generate index
        working-directory: main
        run: |
          # Wait 10s for release to get finished.
          sleep 10
          uv run tools/make_index2 ../pypi/${{ inputs.name}}/index.html

      - name: Deploy index
        working-directory: pypi
        run: |
          if [[ -z "$(git status --porcelain)" ]]; then
              echo "No changes to commit"
              exit 0
          fi
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          git add .
          git commit -m "ci: Add wheels for ${{ inputs.name }}-${{ needs.meta.outputs.version }}"
          git push origin HEAD:pypi

...
# vim: set tw=98:
